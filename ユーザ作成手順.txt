
初回の登録はUI上からできない。
更新は、バージョンアップという形で行われる。


現在のポリシーでは削除ができない。
下記のポリシーでenginpath以下の操作ができる。
vault policy write user02 - <<EOF
path "enginpath/*" {
  capabilities = ["create", "update", "patch", "read", "delete"]
}
EOF
CLIでは、vaersion historyが表示できない。(UI上、rootのみ API不明)


vault-0 ポッドでインタラクティブ シェル セッションを開始します。
kubectl -n vault exec -it vault-0 -- /bin/sh

プロンプトが表示されたら、ルート トークンを使用してログインします。
vault login
  "root_token": "hvs.SyVFP6Rut15qiJ0m5eV4Twv1"

●ポリシー登録
Policyname: user02
SecretAccessPath: enginpath/data/group01/user01
capabilities: ["create", "update", "patch", "read", "delete"]
下記で指定すると表示されない。
SecretPath: enginpath/group01/user01

ポリシーを書き出します。
vault policy write user02 - <<EOF
path "enginpath/data/group01/user01" {
  capabilities = ["create", "update", "patch", "read", "delete"]
}
EOF

●ユーザーパス認証方法を有効
vault auth enable userpass
vault auth list

●Userpass認証構成
ユーザ名: user02
構成ファイル: auth/userpass/users/user02
Password: JMCVF7eO4Oox8CZ
Policyname: user02 

認証が許可されているユーザーで構成
vault write auth/userpass/users/user02 \
    password=JMCVF7eO4Oox8CZ \
    policies=user02





[anjack@30master vault]$ kubectl -n vault get all
NAME                                        READY   STATUS    RESTARTS     AGE
pod/vault-0                                 1/1     Running   1 (9h ago)   7d7h
pod/vault-1                                 1/1     Running   1 (9h ago)   7d7h
pod/vault-2                                 1/1     Running   1 (9h ago)   7d7h
pod/vault-agent-injector-59b9c84fd8-vdlrs   1/1     Running   1 (9h ago)   7d7h

NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                         AGE
service/vault                      ClusterIP   10.109.40.192    <none>        8200/TCP,8201/TCP               7d7h
service/vault-active               ClusterIP   10.106.124.150   <none>        8200/TCP,8201/TCP               7d7h
service/vault-agent-injector-svc   ClusterIP   10.107.253.132   <none>        443/TCP                         7d7h
service/vault-internal             ClusterIP   None             <none>        8200/TCP,8201/TCP               7d7h
service/vault-nodeport             NodePort    10.100.230.217   <none>        8200:31265/TCP,8201:31411/TCP   7d6h
service/vault-standby              ClusterIP   10.102.83.108    <none>        8200/TCP,8201/TCP               7d7h

NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/vault-agent-injector   1/1     1            1           7d7h

NAME                                              DESIRED   CURRENT   READY   AGE
replicaset.apps/vault-agent-injector-59b9c84fd8   1         1         1       7d7h

NAME                     READY   AGE
statefulset.apps/vault   3/3     7d7h
[anjack@30master vault]$

[anjack@30master vault]$ kubectl -n vault get PodDisruptionBudget
NAME    MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE
vault   N/A             1                 1                     7d7h
[anjack@30master vault]$ kubectl -n vault get PodDisruptionBudget -o yaml
apiVersion: v1
items:
- apiVersion: policy/v1
  kind: PodDisruptionBudget
  metadata:
    annotations:
      meta.helm.sh/release-name: vault
      meta.helm.sh/release-namespace: vault
    creationTimestamp: "2022-12-19T02:05:21Z"
    generation: 1
    labels:
      app.kubernetes.io/instance: vault
      app.kubernetes.io/managed-by: Helm
      app.kubernetes.io/name: vault
      helm.sh/chart: vault-0.23.0
    name: vault
    namespace: vault
    resourceVersion: "642589"
    uid: 69cbd28c-6ab1-4201-a32e-0957e8778192
  spec:
    maxUnavailable: 1
    selector:
      matchLabels:
        app.kubernetes.io/instance: vault
        app.kubernetes.io/name: vault
        component: server
  status:
    conditions:
    - lastTransitionTime: "2022-12-26T00:21:18Z"
      message: ""
      observedGeneration: 1
      reason: SufficientPods
      status: "True"
      type: DisruptionAllowed
    currentHealthy: 3
    desiredHealthy: 2
    disruptionsAllowed: 1
    expectedPods: 3
    observedGeneration: 1
kind: List
metadata:
  resourceVersion: ""


[anjack@30master vault]$ kubectl -n vault get MutatingWebhookConfiguration -o yaml
apiVersion: v1
items:
- apiVersion: admissionregistration.k8s.io/v1
  kind: MutatingWebhookConfiguration
  metadata:
    annotations:
      meta.helm.sh/release-name: vault
      meta.helm.sh/release-namespace: vault
    creationTimestamp: "2022-12-19T02:05:23Z"
    generation: 3
    labels:
      app.kubernetes.io/instance: vault
      app.kubernetes.io/managed-by: Helm
      app.kubernetes.io/name: vault-agent-injector
    name: vault-agent-injector-cfg
    resourceVersion: "641197"
    uid: c3a1a0ac-3834-4679-baa4-d85132f27986
  webhooks:
  - admissionReviewVersions:
    - v1
    - v1beta1
    clientConfig:
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNTRENDQWU2Z0F3SUJBZ0lVWG4xV1R0dDVBMG9DbEhodXNJNjZmekhnbjdzd0NnWUlLb1pJemowRUF3SXcKR2pFWU1CWUdBMVVFQXhNUFFXZGxiblFnU1c1cVpXTjBJRU5CTUI0WERUSXlNVEl4T1RBeU1EUXlOVm9YRFRNeQpNVEl4TmpBeU1EVXlOVm93R2pFWU1CWUdBMVVFQXhNUFFXZGxiblFnU1c1cVpXTjBJRU5CTUZrd0V3WUhLb1pJCnpqMENBUVlJS29aSXpqMERBUWNEUWdBRUp6dVVRa0lZeklBWnAzWXNPNFJCRmU2SzBBZTZQU2VHQVpSOFNCSU0KbWxldUxBOFNSclc3ZysrclkvSHFXYmpIZzR5UVI3UVhiVk9JamV5UkJ0QktCYU9DQVJBd2dnRU1NQTRHQTFVZApEd0VCL3dRRUF3SUNoREFUQmdOVkhTVUVEREFLQmdnckJnRUZCUWNEQVRBUEJnTlZIUk1CQWY4RUJUQURBUUgvCk1HZ0dBMVVkRGdSaEJGOW1Nam8wTURvMU5Eb3pZem93T1Rvd1pqcGxaVHBoTURvd05qcG1aRHBtWXpwaE1UcGwKT0Rvd056bzVZVG80TXpvek1EbzBZem8zTkRwaFpqbzVZem94TVRvMU1qcGhPVHBsTVRwbE5qb3lZVG8yTURveQpOem8zTnpvek5qcGtZVEJxQmdOVkhTTUVZekJoZ0Y5bU1qbzBNRG8xTkRvell6b3dPVG93WmpwbFpUcGhNRG93Ck5qcG1aRHBtWXpwaE1UcGxPRG93TnpvNVlUbzRNem96TURvMFl6bzNORHBoWmpvNVl6b3hNVG8xTWpwaE9UcGwKTVRwbE5qb3lZVG8yTURveU56bzNOem96Tmpwa1lUQUtCZ2dxaGtqT1BRUURBZ05JQURCRkFpRUE3VjRqdEliWgoxaEl5WVM2NmFWWlZwRWhsdTlvcUR1TXhheWdCbFRuNmU1c0NJQ0s0bEl4S0JjTkJqNjZhTDF2anhVeHdISis0CnhlUDBYZVNTMGw5VXc5Wm4KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQotLS0tLUJFR0lOIENFUlRJRklDQVRFLS0tLS0KTUlJQ1J6Q0NBZTZnQXdJQkFnSVVRSzZVellQMW94MkNWRk5iZmJRYnozOStIY1V3Q2dZSUtvWkl6ajBFQXdJdwpHakVZTUJZR0ExVUVBeE1QUVdkbGJuUWdTVzVxWldOMElFTkJNQjRYRFRJeU1USXlOakF3TURrd04xb1hEVE15Ck1USXlNekF3TVRBd04xb3dHakVZTUJZR0ExVUVBeE1QUVdkbGJuUWdTVzVxWldOMElFTkJNRmt3RXdZSEtvWkkKemowQ0FRWUlLb1pJemowREFRY0RRZ0FFY1RLckxGQk9iOUtUcFpPWDVzQm8zVnp1ZEs3L3NCQW81RUdIZnVDNAppT3ZUMkxLQnN2VFZnd0ZCK3JiN2h5N3IyRXBxY0dkY2F3cmxETmg2UktNeFlLT0NBUkF3Z2dFTU1BNEdBMVVkCkR3RUIvd1FFQXdJQ2hEQVRCZ05WSFNVRUREQUtCZ2dyQmdFRkJRY0RBVEFQQmdOVkhSTUJBZjhFQlRBREFRSC8KTUdnR0ExVWREZ1JoQkY4eE1Eb3hPVG8xTnpvek16cGhOVG8wTURwbE16cGpPRG96TkRveFpqbzVNVG94TVRwawpNVG8yWkRvMVl6b3dZanBoTnpveFpUbzBNem8yTlRvM016cGxNVHBqTVRvME9UbzRNRG8yTnpvNFpUcGtNRG8wCk56b3haVHBoWmpveU5qQnFCZ05WSFNNRVl6QmhnRjh4TURveE9UbzFOem96TXpwaE5UbzBNRHBsTXpwak9Eb3oKTkRveFpqbzVNVG94TVRwa01UbzJaRG8xWXpvd1lqcGhOem94WlRvME16bzJOVG8zTXpwbE1UcGpNVG8wT1RvNApNRG8yTnpvNFpUcGtNRG8wTnpveFpUcGhaam95TmpBS0JnZ3Foa2pPUFFRREFnTkhBREJFQWlBcTJSRHdoR3lHCnlRUzRyZmIvaVd6ZnlaN0p1OXNqMXNpS3BWUkVvRWJqUEFJZ0dkQytTOExKVXpzTHFkYlMxZ1ZOelZKQXRlUmIKOTZ2V0E2NGxPbEZPRWxRPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
      service:
        name: vault-agent-injector-svc
        namespace: vault
        path: /mutate
        port: 443
    failurePolicy: Ignore
    matchPolicy: Exact
    name: vault.hashicorp.com
    namespaceSelector: {}
    objectSelector:
      matchExpressions:
      - key: app.kubernetes.io/name
        operator: NotIn
        values:
        - vault-agent-injector
    reinvocationPolicy: Never
    rules:
    - apiGroups:
      - ""
      apiVersions:
      - v1
      operations:
      - CREATE
      - UPDATE
      resources:
      - pods
      scope: '*'
    sideEffects: None
    timeoutSeconds: 30
kind: List
metadata:
  resourceVersion: ""



