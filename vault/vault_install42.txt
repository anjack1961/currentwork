
注入されたシークレットにテンプレートを適用する

patch-inject-secrets-as-template.yaml

spec:
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: 'true'
        vault.hashicorp.com/agent-inject-status: 'update'
        vault.hashicorp.com/role: 'internal-app'
        vault.hashicorp.com/agent-inject-secret-database-config.txt: 'internal/data/database/config'
        vault.hashicorp.com/agent-inject-template-database-config.txt: |
          {{- with secret "internal/data/database/config" -}}
          postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard
          {{- end -}}

このパッチには、2 つの新しい注釈が含まれています。
  agent-inject-statusupdate : インジェクターにこれらの値を再注入するように設定します。
  agent-inject-template-FILEPATH : ファイル パスの前にプレフィックスを付けます。この値は 、シークレットのデータに適用するVault Agent テンプレートを定義します。
テンプレートは、ユーザー名とパスワードを PostgreSQL 接続文字列としてフォーマットします。

更新された注釈を適用します。
minikube kubectl -- patch deployment orgchart --patch "$(cat patch-inject-secrets-as-template.yaml)"
[anjack@110master vault]$ minikube kubectl -- patch deployment orgchart --patch "$(cat patch-inject-secrets-as-template.yaml)"
deployment.apps/orgchart patched

デフォルトの名前空間にあるすべてのポッドを取得します。
minikube kubectl -- get pods -o wide

[anjack@110master vault]$ minikube kubectl -- get pods -o wide
NAME                                    READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES
orgchart-696cf797b5-88v5n               2/2     Running   0          20s   172.17.0.5   minikube   <none>           <none>
vault-0                                 1/1     Running   0          10m   172.17.0.4   minikube   <none>           <none>
vault-agent-injector-5b75fd986d-b6w7z   1/1     Running   0          10m   172.17.0.3   minikube   <none>           <none>


最後に、ポッド内のorgchartコンテナーに 書き込まれたシークレットを表示します。orgchart
minikube kubectl -- exec \
    $(minikube kubectl -- get pod -l app=orgchart -o jsonpath="{.items[0].metadata.name}") \
    -c orgchart -- cat /vault/secrets/database-config.txt

[anjack@110master vault]$ minikube kubectl -- exec \
>     $(minikube kubectl -- get pod -l app=orgchart -o jsonpath="{.items[0].metadata.name}") \
>     -c orgchart -- cat /vault/secrets/database-config.txt
postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard[anjack@110master vault]$






